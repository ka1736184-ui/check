<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin | MixerCheck</title>
<style>
  body { font-family: Segoe UI, system-ui; padding: 16px; }
  table { width: 100%; border-collapse: collapse; margin-top: 16px; }
  th, td { padding: 8px; border: 1px solid #ddd; }
  input { padding: 6px; width: 100%; }
  button { padding: 6px; margin: 2px; }
</style>
</head>
<body>

<h1>Админ-панель</h1>
<p>Текущий админ: <span id="adminName"></span></p>
<button id="toOsnova">Открыть osnova</button>
<button id="toEverything">Открыть everything</button>
<button id="logout">Выйти</button>

<h2>Пользователи</h2>
<table id="usersTable">
  <thead>
    <tr><th>Логин</th><th>Роль</th><th>Access</th><th>Действия</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h3>Добавить пользователя</h3>
<input id="newUsername" placeholder="Логин">
<input id="newPassword" placeholder="Пароль">
<input id="newAccess" placeholder="Доступ (через запятую)">
<button id="addUserBtn">Добавить</button>

<script type="module">
import { db } from './firebase.js';
import { collection, getDocs, addDoc, deleteDoc, doc, updateDoc, getDoc } from 'https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js';

const usersRef = collection(db, 'users');
const tbody = document.querySelector('#usersTable tbody');
const adminName = document.getElementById('adminName');

const userId = localStorage.getItem('userId');
const username = localStorage.getItem('username');

if (!userId) window.location.href = 'index.html';

// Проверка роли admin
async function ensureAdmin() {
  try {
    const uDocRef = doc(db, 'users', userId);
    const uSnap = await getDoc(uDocRef);
    if (!uSnap.exists() || uSnap.data().role !== 'admin') {
      alert('Доступ запрещён');
      window.location.href = 'index.html';
    }
  } catch(err) {
    console.error(err);
    window.location.href = 'index.html';
  }
}

adminName.textContent = username;

// Навигация
document.getElementById('toOsnova').addEventListener('click', ()=>window.location.href='osnova.html');
document.getElementById('toEverything').addEventListener('click', ()=>window.location.href='everything.html');
document.getElementById('logout').addEventListener('click', ()=>{
  localStorage.removeItem('userId');
  localStorage.removeItem('username');
  window.location.href='index.html';
});

// Загрузка пользователей
async function loadUsers(){
  tbody.innerHTML = '';
  const q = await getDocs(usersRef);
  q.forEach(docSnap => {
    const data = docSnap.data();

    // если админ — даём полный доступ
    const accessList = data.role === "admin" ? ["osnova.html","everything.html","admin.html"] : (data.access || []);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${data.username || ''}</td>
      <td>${data.role || 'user'}</td>
      <td><input data-id="${docSnap.id}" class="accessInput" value="${accessList.join(',')}"></td>
      <td>
        <button class="saveBtn" data-id="${docSnap.id}">Сохранить</button>
        <button class="delBtn" data-id="${docSnap.id}">Удалить</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.querySelectorAll('.saveBtn').forEach(b => b.addEventListener('click', saveUser));
  document.querySelectorAll('.delBtn').forEach(b => b.addEventListener('click', delUser));
}

// Сохранение доступа
async function saveUser(e){
  const id = e.target.dataset.id;
  const input = document.querySelector(`input[data-id="${id}"]`);
  const access = input.value.split(',').map(s => s.trim()).filter(Boolean);

  try {
    const uSnap = await getDoc(doc(db,'users',id));
    if(uSnap.data().role === 'admin'){
      alert('Админ всегда имеет полный доступ');
      return;
    }

    await updateDoc(doc(db,'users',id), { access });
    alert('Сохранено');
    loadUsers();
  } catch(err){
    console.error(err);
    alert('Ошибка при сохранении');
  }
}

// Удаление пользователя
async function delUser(e){
  const id = e.target.dataset.id;
  const uSnap = await getDoc(doc(db,'users',id));
  if(uSnap.data().role === 'admin'){
    alert('Нельзя удалить админа!');
    return;
  }

  if(!confirm('Удалить пользователя?')) return;
  try {
    await deleteDoc(doc(db,'users',id));
    loadUsers();
  } catch(err){
    console.error(err);
    alert('Ошибка при удалении');
  }
}

// Добавление пользователя
document.getElementById('addUserBtn').addEventListener('click', async ()=>{
  const u = document.getElementById('newUsername').value.trim();
  const p = document.getElementById('newPassword').value.trim();
  const a = document.getElementById('newAccess').value.split(',').map(s=>s.trim()).filter(Boolean);
  if(!u || !p) return alert('Введите логин и пароль');

  try {
    await addDoc(usersRef, { username: u, password: p, role: 'user', access: a });
    alert('Пользователь добавлен');
    loadUsers();
  } catch(err){
    console.error(err);
    alert('Ошибка при добавлении пользователя');
  }
});

// Инициализация
await ensureAdmin();
await loadUsers();

</script>

</body>
</html>
