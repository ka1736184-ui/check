<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–∏–∑–∞–π–Ω —Å—Ç—É–¥–∏—è ‚Äî –ü–∞–Ω–µ–ª—å</title>
<style>
body{font-family:Arial,sans-serif;background:#0d0f12;color:#fff;margin:0}
.topbar{background:#14171c;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 20px}
button{padding:6px 12px;border:none;border-radius:8px;background:#4c6ef5;color:#fff;cursor:pointer}
.container{padding:20px}
.card{background:#14171c;padding:16px;border-radius:12px;margin-bottom:12px}
input,select{padding:6px;width:100%;margin:6px 0;border-radius:8px;background:#0f1316;color:#fff;border:1px solid #333}
table{width:100%;border-collapse:collapse}
th,td{padding:8px;border-bottom:1px solid #333;text-align:left}
.controls{display:flex;gap:6px}
.hidden{display:none}
.status-pill{padding:4px 6px;border-radius:999px;background:#4c6ef5;font-size:12px}
</style>
</head>
<body>
<div class="topbar">
  <div>DesignStudio</div>
  <div>
    <span id="userLabel"></span>
    <button onclick="logout()">–í—ã–π—Ç–∏</button>
  </div>
</div>

<div class="container">
  <div class="card">
    <h3>–ü—Ä–æ–µ–∫—Ç—ã</h3>
    <input id="projName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞">
    <select id="projStatus">
      <option>‚è≥ –†–∞–±–æ—Ç–∞</option>
      <option>‚úÖ –ì–æ—Ç–æ–≤</option>
      <option>üí∞ –û–ø–ª–∞—Ç–∞</option>
    </select>
    <input id="projBudget" placeholder="–ë—é–¥–∂–µ—Ç">
    <button id="addProjectBtn">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
    <table>
      <thead><tr><th>–ü—Ä–æ–µ–∫—Ç</th><th>–°—Ç–∞—Ç—É—Å</th><th>–ë—é–¥–∂–µ—Ç</th><th>–î–µ–π—Å—Ç–≤–∏—è</th></tr></thead>
      <tbody id="projTable"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4X8TIIegH0En1tuUspJtixyc-dcx1_9Y",
  authDomain: "studia-35b43.firebaseapp.com",
  projectId: "studia-35b43",
  storageBucket: "studia-35b43.firebasestorage.app",
  messagingSenderId: "186158637676",
  appId: "1:186158637676:web:e62c3261a06441e4fb2e49",
  measurementId: "G-L339B7CMZK"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

let isAdmin = false;
let projects = [];
let userLogin = "";

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
onAuthStateChanged(auth, async user => {
  if(!user){ window.location.href="auth.html"; return; }
  document.getElementById('userLabel').innerText = user.email;
  userLogin = user.email.split('@')[0];
  const docSnap = await getDoc(doc(db, "users", userLogin));
  if(docSnap.exists()) isAdmin = docSnap.data().admin;
  await loadProjects();
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤ –∏–∑ Firestore
async function loadProjects(){
  const projSnap = await getDocs(collection(db, "projects"));
  projects = [];
  projSnap.forEach(doc => projects.push({id: doc.id, ...doc.data()}));
  renderProjects();
}

// --- –ü–∞–Ω–µ–ª—å –ø—Ä–æ–µ–∫—Ç–æ–≤ ---
function renderProjects(){
  const tbody = document.getElementById('projTable');
  tbody.innerHTML = '';
  projects.forEach((p,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${p.name}</td>
      <td><span class="status-pill">${p.status}</span></td>
      <td>${p.budget}</td>
      <td>
        <div class="controls" style="display:${isAdmin?'flex':'none'}">
          <button onclick="deleteProject('${p.id}')">üóëÔ∏è</button>
        </div>
      </td>`;
    tbody.appendChild(tr);
  });
}

// --- –î–æ–±–∞–≤–ª–µ–Ω–∏–µ ---
document.getElementById('addProjectBtn').onclick = async ()=>{
  if(!isAdmin){ alert("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å –ø—Ä–æ–µ–∫—Ç—ã"); return; }
  const name = document.getElementById('projName').value.trim();
  const status = document.getElementById('projStatus').value;
  const budget = document.getElementById('projBudget').value.trim();
  if(!name){ alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"); return; }
  const newProjRef = doc(db, "projects", name + "_" + Date.now());
  await setDoc(newProjRef, {name,status,budget});
  await loadProjects();
  document.getElementById('projName').value = "";
  document.getElementById('projBudget').value = "";
};

// --- –£–¥–∞–ª–µ–Ω–∏–µ ---
async function deleteProject(id){
  if(!isAdmin){ alert("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å –ø—Ä–æ–µ–∫—Ç—ã"); return; }
  if(!confirm("–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ–µ–∫—Ç?")) return;
  await deleteDoc(doc(db, "projects", id));
  await loadProjects();
}

// --- –í—ã—Ö–æ–¥ ---
function logout(){ signOut(auth).then(()=>window.location.href="auth.html"); }
</script>
</body>
</html>
